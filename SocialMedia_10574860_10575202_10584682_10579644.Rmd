---
title: "Comparison Between the Facebook Pages for Different Platforms"
author: "Jack Brewer, Aden Webb, Avebry Haughton-Vowles, Kacper Mazur"
date: "12 February 2018"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#---Packages---
library(Rfacebook)
citation("Rfacebook")
library(stringr) # Character manipulation
library(dplyr) # Data wrangling
library(ggplot2) # Graphics
library(tidyr) # Turning wide data into long data
library(tm) # Text mining
library(wordcloud) # Word cloud
library(network) # Network diagram
library(curl) # Needed to get information about me and my friends
library(httr) # Needed to get information about me and my friends
library(lubridate) # For date manipulation
library(scales) # To format axes
library(wordcloud2)

#---Functions---

format.facebook.date <- function(datestring) {
  date <- as.POSIXct(datestring, 
                     format = "%Y-%m-%dT%H:%M:%S+0000", 
                     tz = "GMT")
  date
}

remove_http_www <- function(some_txt){
    #
    some_txt <- str_replace_all(some_txt, 
                                "http\\:\\/\\/[A-Za-z0-9\\.\\/\\?\\=]+(\\s?)", "")
    #
    some_txt <- str_replace_all(some_txt, 
                                "https\\:\\/\\/[A-Za-z0-9\\.\\/\\?\\=]+(\\s?)", "")
    # 
    some_txt <- str_replace_all(some_txt, 
                                "www\\.[A-Za-z0-9\\.\\/\\?\\=]+(\\s?)", "")
    #
    return(some_txt)
}

remove.numbers <- function(some_txt){
    # Remove separate numbers
    some_txt <- str_replace_all(some_txt, "\\s\\d+", " ") #
    #
    # Remove numbers in brackets
    some_txt <- str_replace_all(some_txt, "\\(\\d+\\)", "") 
    #
    # Remove numbers at the beginning
    some_txt <- str_replace_all(some_txt, "^\\d+\\s", "")
    #
    # Remove numbers at the end
    some_txt <- str_replace_all(some_txt, "\\s\\d+$", "")
    #
    some_txt
}

remove.spaces <- function(some_txt){
    # If more than one space, replace by one space
    some_txt <- str_replace_all(some_txt, "\\s{2,}", " ") 
    #
    # Remove beginning and ending spaces
    some_txt <-  str_replace_all(some_txt, "^\\s+|\\s+$", "")
    #
    some_txt
}

match_with_negation <- function(phrase, word_table, consider_negation = TRUE,
                                negation_dictionary = c("not", "isn't","aren't", "haven't","won't", "doesn't")){
    #
    # phrase is the phrase being considered
    # word_table is the dictionary of words in which we are looking for matches
    # consider_negation: if TRUE,
    # then the appearance of a negation word before a match is taken into account
    # negation_dictionary is a list of negation words (which we can add to)
    #
    # Obtain the individual words in phrase
    #
    individual_words <- unlist(str_split(phrase, '\\s+')) # Needs package stringr
    #
    # Remove the English articles as these can cause confusion when considering negation
    #
    individual_words <- individual_words[!individual_words %in% c("a", "the")]
    #
    # Where are the matches?
    # Position of the word in the word_table
    # If there is no match NA is reported
    #
    match_positions_in_table <- match(individual_words, word_table)
    #
    # So words that match are those that are not NA
    # Let's record which ones these are
    #
    match_positions_in_phrase <- which(!is.na(match_positions_in_table))
    #
    # How many matches?
    # This is the total number of elements that are not NA
    #
    number_of_matches <- sum(!is.na(match_positions_in_table))
    #
    # If we should take account of the appearance of a negation word before a match:
    #
    if(consider_negation){
        #
        # Position of preceding words
        #
        previous_words_position <- match_positions_in_phrase - 1
        #
        # Make sure that none of these are zero, as we can't index from zero
        #
        previous_words_position <- previous_words_position[previous_words_position > 0]
        #
        # What are those words?
        #
        previous_words <- individual_words[previous_words_position]
        #
        # Do they negate?
        #
        negation_words <- previous_words[previous_words %in% negation_dictionary]
        #
        # Remove the number of negation words from the number of matches
        #
        number_of_matches <- number_of_matches - length(negation_words)
        # So a phrase such as "not good" is recorded as neutral (score 0)
        # rather than 1 for the positive word "good"
    }
    #
    # Return the number of matches
    #
    number_of_matches
}

get.page.data <- function(page_name) {
  

}

token <- "EAACEdEose0cBAOD9nUMYLmvbgEr7wpVPGsgJWVCJazzqlc60NJfT8iRPQHQd4OkupNZCm6bDMsN4e7FWDZCt6Pv0pz5ALUmQvZAfDZAZBZCtyTgOaRFFWL4cqjSvtmdUlPld4t5uWs1WkGPjkVKREUuH7vri8vWZClxIZAvqapzKtZCcgA7lm71PZByZBEhIO1voqn1ZCZA8mPnwJrQZDZD"


```

## Introduction

We chose to do our presentation on the similarities and differences between various game platforms. We chose this as it is something we are familier with, due to us all being games development students, and it could be interesting to look at different variations of the same service.


## Chosen Pages

The three services we will be looking at are:

- Xbox
- Playstation
- Steam

We chose these as they are the most widely used platforms and so were likely to yield the most active FaceBook Pages.

## Xbox and Playstation

These two are both examples of console gaming platforms. They are usually cheaper to get into with a lower barrier of entry. There is a larger focus on major releases periodically throughout the year.

We chose to use two examples of consoles because they are in direct competition so there is the possiblility of analysing similarities and differences between the two.

## Steam

Steam was picked to compare against the two console platforms. It is the primary method for gaming on a PC and therefore tends to have a higher barrier for enrty as a PC can be more expensive up-front than a console. 

Steam also gets the major releases at distinct points throughout the year but has a much greater focus on smaller games releasing very rapidly; almost constantly.

## Playstation

```{r include=FALSE}

playstationPageName <- "PlayStation"
number_required <- 1000
dates <- seq(as.Date("2017/01/31"), as.Date("2018/01/31"), by = "day")
n <- length(dates) - 1
df_daily <- list()

for (i in 1:n){
  cat(as.character(dates[i]), " ")
  try(df_daily[[i]] <- getPage(playstationPageName, token,
                               n = number_required,
                               since = dates[i],
                               until = dates[i + 1],
                               reactions = TRUE,
                               api = "v2.9"))
  cat("\n")
}

playstationPage <- do.call(rbind, df_daily)

playstationPage <- playstationPage %>%
  mutate(datetime = format.facebook.date(created_time) )

head(playstationPage$datetime)

playstationPage <- playstationPage %>%
  mutate(month = format(datetime, "%Y-%m"))

head(playstationPage$month)

playstation_monthly_summaries_wide <- playstationPage %>%
  group_by(month) %>%
  summarize("Average likes" = mean(likes_count),
            "Average comments" = mean(comments_count),
            "Average shares" = mean(shares_count),
            "Number of posts" = n())

playstation_monthly_summaries <- playstation_monthly_summaries_wide %>%
  gather("Monthly_Quantity","Number", 2:5)
```

```{r echo=FALSE, warning=FALSE}
ggplot(playstation_monthly_summaries, 
       aes(x = month, 
           y = Number, 
           group = Monthly_Quantity, 
           colour = Monthly_Quantity)) +
  geom_line(lwd = 1.5) + 
  facet_wrap(~ Monthly_Quantity, scales = "free_y") + 
  theme(axis.text.x = element_text(size = 14, angle = 270, hjust = 0, vjust = 0.5),
        axis.text.y = element_text(size = 14), 
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16, angle = 270),
        strip.text.x = element_text(size = 14),
        title = element_text(size = 20), 
        legend.position = "none") + 
  labs(title = paste(playstationPageName, "Facebook Page"), 
       subtitle = "Monthly Quantity Across Posts",
       x = "Month", 
       y = "Number")
```

## Negative and Positive Words in the Playstation Comments

```{r, include=FALSE}
playstationPage$message
playstationPage_existing_messages <- playstationPage %>% 
  filter(!is.na(message))
playstationPage_existing_messages <- playstationPage_existing_messages %>% 
  mutate(message_cleaned = remove_http_www(message))
playstationPage_existing_messages <- playstationPage_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[^[:alnum:]]",  " ") )
playstationPage_existing_messages <- playstationPage_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[\u4E00-\u9FFF]+",  " ") )
playstationPage_existing_messages <- playstationPage_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[\u3400-\u4DBF]+",  " ") )
playstationPage_existing_messages <- playstationPage_existing_messages %>% 
  mutate(message_cleaned = remove.numbers(message_cleaned))
playstationPage_existing_messages <- playstationPage_existing_messages %>% 
  mutate(message_cleaned = remove.spaces(message_cleaned))
playstationPage_existing_messages <- playstationPage_existing_messages %>% 
  mutate(message_cleaned =  tolower(message_cleaned))
playstationPage_existing_messages$message_cleaned

#Word Counts/Frequency
text_corpus <- Corpus(VectorSource(playstationPage_existing_messages$message_cleaned))
text_corpus

new.stopwords <- c("http", "https", "ps4", "playstation", "sony")

tdm <- TermDocumentMatrix(text_corpus, 
                          control = list(stopwords = c(new.stopwords, 
                                                       stopwords(kind = "en"))))
tdm_matrix <- as.matrix(tdm)
dim(tdm_matrix)
tdm_matrix[1:25, 1:25]
word_count <- rowSums(tdm_matrix)
head(word_count)
word_count_df <- data.frame(word = names(word_count), freq = word_count)
word_count_ordered_df <- word_count_df %>% 
  arrange(desc(freq))
head(word_count_ordered_df)

N <- 8
ps_words_freq_limited <- word_count_ordered_df[1:N,]
ps_words_freq_limited <- ps_words_freq_limited %>% 
  mutate(word = factor(word, levels = word))
ps_words_freq_limited$word
```

```{r, echo=FALSE}

g_w_b <- rep(c("darkblue", "white", "black"), length = N)
ggplot(ps_words_freq_limited, 
       aes(x = word, 
           y = freq)) +
  geom_col(fill = g_w_b, colour = "black", alpha = 0.9) + 
  # colour refers to the edge of the bars        
  # values of alpha less than 1 cause transparency
  labs(title = paste("Most Common Words - ", playstationPageName),
       x = paste("Top", N, "Words"), 
       y = "Frequency") + 
  theme(axis.text = element_text(size = 14, color = "black"), 
        axis.title = element_text(size = 18, color = "black"),
        title = element_text(size = 20))
     
```


## Steam

```{r, include=FALSE}
steamPageName <- "Steam"

number_required <- 1000 

dateToUse <- "2018/01/31"

dates <- seq(as.Date("2017/01/31"), as.Date(dateToUse), by = "day")
dates

n <- length(dates) - 1
n

df_daily <- list()

for (i in 1:n){
  
  cat(as.character(dates[i]), " ") 
  
  try(df_daily[[i]] <- getPage(steamPageName, token, 
                               n = number_required, 
                               since = dates[i], 
                               until = dates[i + 1], 
                               reactions = TRUE,
                               api = "v2.9")) 
  
  cat("\n")
}

steamPage <- do.call(rbind, df_daily)

steamPage <- steamPage %>% 
  mutate(datetime = format.facebook.date(created_time) )

head(steamPage$datetime)

steamPage <- steamPage %>% 
  mutate(month = format(datetime, "%Y-%m"))

steam_monthly_summaries_wide <- steamPage %>%
  group_by(month) %>%
  summarize("Average likes" = mean(likes_count),
            "Average comments" = mean(comments_count),
            "Average shares" = mean(shares_count),
            "Number of posts" = n())

steam_monthly_summaries <- steam_monthly_summaries_wide %>% 
  gather("Monthly_Quantity","Number", 2:5) 
```

```{r, echo=FALSE}
ggplot(steam_monthly_summaries, 
       aes(x = month, 
           y = Number, 
           group = Monthly_Quantity, 
           colour = Monthly_Quantity)) +
  geom_line(lwd = 1.5) + # Specify line width 
  facet_wrap(~ Monthly_Quantity, scales = "free_y") + # Use a free scale on the y-axis
  theme(axis.text.x = element_text(size = 14, angle = 270, hjust = 0, vjust = 0.5), # For rotated labels
        axis.text.y = element_text(size = 14), 
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16, angle = 270),
        strip.text.x = element_text(size = 14),
        title = element_text(size = 20), 
        legend.position = "none") + 
  labs(title = paste(steamPageName, "Facebook Page"), # Note the use of paste to create a title of the page name followed by some text (see below)
       subtitle = "Monthly Quantity Across Posts",
       x = "Month", 
       y = "Number") 

```

## Negative and Positive Words in the Steam Comments

```{r, include=FALSE}
steam_existing_messages <- steamPage %>% 
  filter(!is.na(message))
steam_existing_messages <- steam_existing_messages %>% 
  mutate(message_cleaned = remove_http_www(message))
steam_existing_messages <- steam_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[^[:alnum:]]",  " ") )
steam_existing_messages <- steam_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[\u4E00-\u9FFF]+",  " ") )
steam_existing_messages <- steam_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[\u3400-\u4DBF]+",  " ") )
steam_existing_messages <- steam_existing_messages %>% 
  mutate(message_cleaned = remove.numbers(message_cleaned))
steam_existing_messages <- steam_existing_messages %>% 
  mutate(message_cleaned = remove.spaces(message_cleaned))
steam_existing_messages <- steam_existing_messages %>% 
  mutate(message_cleaned =  tolower(message_cleaned))
steam_existing_messages$message_cleaned

#Word Counts/Frequency
text_corpus <- Corpus(VectorSource(steam_existing_messages$message_cleaned))
text_corpus

new.stopwords <- c("http", "https", "steam", "valve", "pc")

tdm <- TermDocumentMatrix(text_corpus, 
                          control = list(stopwords = c(new.stopwords, 
                                                       stopwords(kind = "en"))))
tdm_matrix <- as.matrix(tdm)
dim(tdm_matrix)
tdm_matrix[1:25, 1:25]
word_count <- rowSums(tdm_matrix)
head(word_count)
word_count_df <- data.frame(word = names(word_count), freq = word_count)
steam_word_count_ordered_df <- word_count_df %>% 
  arrange(desc(freq))
head(word_count_ordered_df)

N <- 8
steam_words_freq_limited <- steam_word_count_ordered_df[1:N,]
steam_words_freq_limited <- steam_words_freq_limited %>% 
  mutate(word = factor(word, levels = word))
steam_words_freq_limited$word
```


```{r, echo=FALSE}
bg <- rep(c("gray0", "gray25", "gray50"), length = N)
ggplot(steam_words_freq_limited, 
       aes(x = word, 
           y = freq)) +
  geom_col(fill = bg, colour = "black", alpha = 0.9) + 
  # colour refers to the edge of the bars        
  # values of alpha less than 1 cause transparency
  labs(title = paste("Most common words in post to page", steamPageName),
       x = paste("Top", N, "Words"), 
       y = "Frequency") + 
  theme(axis.text = element_text(size = 13, color = "black"), 
        axis.title = element_text(size = 18, color = "black"),
        title = element_text(size = 20))
```


##Xbox

```{r, include=FALSE}
xboxPageName <- "xbox"
number_required <- 1000
Sys.Date()
dates <- seq(as.Date("2017/01/31"), as.Date("2018/01/31"), by = "day")
n <- length(dates) - 1
df_daily <- list()
#
for (i in 1:n){
  cat(as.character(dates[i]), " ") 
  try(df_daily[[i]] <- getPage(xboxPageName, token, 
                               n = number_required, 
                               since = dates[i], 
                               until = dates[i + 1], 
                               reactions = TRUE,
                               api = "v2.9"))
  cat("\n")
}
#
xboxPage <- do.call(rbind, df_daily)
# Facebook Stats

xboxPage <- xboxPage %>% 
  mutate(datetime = format.facebook.date(created_time) )
head(xboxPage$datetime)
xboxPage <- xboxPage %>% 
  mutate(month = format(datetime, "%Y-%m"))
head(xboxPage$month)
xbox_monthly_summaries_wide <- xboxPage %>%
  group_by(month) %>%
  summarize("Average likes" = mean(likes_count),
            "Average comments" = mean(comments_count),
            "Average shares" = mean(shares_count),
            "Number of posts" = n())

xbox_monthly_summaries <- xbox_monthly_summaries_wide %>% 
  gather("Monthly_Quantity","Number", 2:5) 
xbox_monthly_summaries
```

```{r}
ggplot(xbox_monthly_summaries, 
       aes(x = month, 
           y = Number, 
           group = Monthly_Quantity, 
           colour = Monthly_Quantity)) +
  geom_line(lwd = 1.5) + # Specify line width 
  facet_wrap(~ Monthly_Quantity, scales = "free_y") + 
  theme(axis.text.x = element_text(size = 14, angle = 270, hjust = 0, vjust = 0.5), 
        axis.text.y = element_text(size = 14), 
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16, angle = 270),
        strip.text.x = element_text(size = 14),
        title = element_text(size = 20), 
        legend.position = "none") + 
  labs(title = paste(xboxPageName, "Facebook Page"), 
       subtitle = "Monthly Quantity Across Posts",
       x = "Month", 
       y = "Number") 
```

## Negative and Positive Words in the Xbox Comments

```{r, include=FALSE}
xbox_existing_messages <- xboxPage %>% 
  filter(!is.na(message))
xbox_existing_messages <- xbox_existing_messages %>% 
  mutate(message_cleaned = remove_http_www(message))
xbox_existing_messages <- xbox_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[^[:alnum:]]",  " ") )
xbox_existing_messages <- xbox_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[\u4E00-\u9FFF]+",  " ") )
xbox_existing_messages <- xbox_existing_messages %>% 
  mutate(message_cleaned = str_replace_all(message_cleaned, "[\u3400-\u4DBF]+",  " ") )
xbox_existing_messages <- xbox_existing_messages %>% 
  mutate(message_cleaned = remove.numbers(message_cleaned))
xbox_existing_messages <- xbox_existing_messages %>% 
  mutate(message_cleaned = remove.spaces(message_cleaned))
xbox_existing_messages <- xbox_existing_messages %>% 
  mutate(message_cleaned =  tolower(message_cleaned))

text_corpus <- Corpus(VectorSource(xbox_existing_messages$message_cleaned))
new.stopwords <- c("http", "https", "youtube", "xbox", "microsoft") 
tdm <- TermDocumentMatrix(text_corpus, 
                          control = list(stopwords = c(new.stopwords, 
                                                       stopwords(kind = "en"))))
tdm_matrix <- as.matrix(tdm)
tdm_matrix[1:25, 1:25]
word_count <- rowSums(tdm_matrix)
head(word_count)
word_count_df <- data.frame(word = names(word_count), freq = word_count)
word_count_ordered_df <- word_count_df %>% 
  arrange(desc(freq))
head(word_count_ordered_df)
N <- 8
xbox_words_freq_limited <- word_count_ordered_df[1:N,]
xbox_words_freq_limited <- xbox_words_freq_limited %>% 
  mutate(word = factor(word, levels = word))
xbox_words_freq_limited$word

```

```{r}
#plots
#-----------------------------
#
col <- rep(c("limegreen", "white"), length = N)

ggplot(xbox_words_freq_limited, 
       aes(x = word, 
           y = freq)) +
  geom_col(fill = col) + 
  labs(title = paste("Most common words in post to page", xboxPageName),
       x = paste("Top", N, "Words"), 
       y = "Frequency") + 
  theme(axis.text = element_text(size = 13, color = "black"), 
        axis.title = element_text(size = 18, color = "black"),
        title = element_text(size = 20))
```

## Possible Explanation for Differing Words and Moods

## Number of comments over a year (all 3)

```{r include=FALSE}
abc <- c(xbox_monthly_summaries_wide$`Average comments`, steam_monthly_summaries_wide$`Average comments`, playstation_monthly_summaries_wide$`Average comments`)


namess <- c("xbox", "steam", "playstation")
namess_f <- factor(namess)

df <- data.frame(abc, namess_f)
df


```

```{r echo=FALSE}
ggplot(df , aes(x = namess_f, y = abc)) +
  geom_boxplot() +
  labs(title = "Box Plots to Show the Number of Comments", x = "Company Name", y = "Number of Comments") + 
  theme(axis.text = element_text(size = 13, color = "black"), 
        axis.title = element_text(size = 13, color = "black"),
        title = element_text(size = 16))
```



## Likes over a year

```{r include=FALSE}

playlikes <- playstationPage$likes_count
xboxlikes <- xboxPage$likes_count
steamlikes <- steamPage$likes_count

playstationPage <- playstationPage %>% 
  mutate(datetime = format.facebook.date(created_time) )

playstationPage <- playstationPage%>% 
  mutate(month = format(datetime, "%Y-%m"))

playstationPage <- select(playstationPage, likes_count, month)
playstationPage

xboxPage <- xboxPage %>% 
  mutate(datetime = format.facebook.date(created_time) )

xboxPage <- xboxPage%>% 
  mutate(month = format(datetime, "%Y-%m"))

xboxPage <- select(xboxPage, likes_count, month)
xboxPage

steamPage <- steamPage %>% 
  mutate(datetime = format.facebook.date(created_time) )

steamPage <- steamPage%>% 
  mutate(month = format(datetime, "%Y-%m"))

steamPage <- select(steamPage, likes_count, month)
steamPage

steamPage$tag <- 1
xboxPage$tag <- 2
playstationPage$tag <- 3


factor_1 <- function(x){
  factor(x,
         levels = c(1,2,3), labels = c("Steam", "Xbox", "Playstation"))
}

steamPage <- collect(steamPage)
playstationPage <- collect(playstationPage)
xboxPage <- collect(xboxPage)

monthly_summaries_wide_steam <- steamPage %>%
  group_by(month) %>%
  summarize("Average likes" = mean(likes_count))

monthly_summaries_wide_xbox <- xboxPage %>%
  group_by(month) %>%
  summarize("Average likes" = mean(likes_count))

monthly_summaries_wide_playstation <- playstationPage %>%
  group_by(month) %>%
  summarize("Average likes" = mean(likes_count))

monthly_summaries_wide_steam$tag <- 1
monthly_summaries_wide_xbox$tag <- 2
monthly_summaries_wide_playstation$tag <- 3

monthly_summaries_wide_steam <- monthly_summaries_wide_steam %>% mutate_at(.vars = vars(3), .funs = funs(factor_1))
monthly_summaries_wide_playstation <- monthly_summaries_wide_playstation %>% mutate_at(.vars = vars(3), .funs = funs(factor_1))
monthly_summaries_wide_xbox <- monthly_summaries_wide_xbox %>% mutate_at(.vars = vars(3), .funs = funs(factor_1))

combined <- data.frame(monthly_summaries_wide_steam)
combined <- rbind.data.frame(monthly_summaries_wide_playstation, monthly_summaries_wide_xbox, monthly_summaries_wide_steam)
combined
```

```{r echo=FALSE}
ggplot(combined, aes(x = month, y = `Average likes`, col = tag, group = tag)) +
  geom_point() +
  geom_line() +
  labs(x = "Month", y = "Average number of likes")
```


## Mood of responses in all three